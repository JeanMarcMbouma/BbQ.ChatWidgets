This document has been consolidated into the repository-level documentation. See `../docs/INDEX.md` and `../../docs/ARCHITECTURE.md` for the updated architecture guides.
# Triage Agent Implementation - Complete Architecture

## System Diagram

```
???????????????????????????????????????????????????????????????????
?                       User Input                                ?
?                       (Chat Message)                            ?
???????????????????????????????????????????????????????????????????
                             ?
???????????????????????????????????????????????????????????????????
?                     TriageAgent<TCategory>                      ?
?  ????????????????????????????????????????????????????????????  ?
?  ? 1. Extract user message from metadata                   ?  ?
?  ? 2. Call classifier.ClassifyAsync()                      ?  ?
?  ? 3. Store classification in metadata                     ?  ?
?  ? 4. Look up agent via registry                           ?  ?
?  ? 5. Invoke specialized agent                            ?  ?
?  ????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
                             ?
        ???????????????????????????????????????????
        ?                    ?                    ?
   ???????????         ???????????         ???????????
   ?Classifier?        ?Agent    ?         ?Metadata ?
   ?          ?        ?Registry ?         ?Context  ?
   ?ClassifyAsync      ?GetAgent ?         ?Get/Set  ?
   ???????????        ???????????         ???????????
        ?
   ??????????????????????????????
   ? IClassifier<TCategory>     ?
   ? Returns: TCategory enum    ?
   ??????????????????????????????
        ?
   Classification Result
   (e.g., UserIntent.HelpRequest)
        ?
   ??????????????????????????????
   ? Routing Mapping            ?
   ? Category ? Agent Name      ?
   ??????????????????????????????
        ?
   ??????????????????????????????????
   ?    Agent Registry              ?
   ?  "help-agent" ? HelpAgent      ?
   ?  "data-query-agent" ? ...      ?
   ?  "action-agent" ? ...          ?
   ?  "feedback-agent" ? ...        ?
   ??????????????????????????????????
        ?
   ??????????????????????????????????
   ?  Specialized Agent Selected    ?
   ?  (HelpAgent, DataQueryAgent,   ?
   ?   ActionAgent, FeedbackAgent)  ?
   ??????????????????????????????????
        ?
   ??????????????????????????????????
   ? Agent Processes Request        ?
   ? Access via InterAgentContext:  ?
   ? - Classification               ?
   ? - User message                 ?
   ? - Previous results             ?
   ??????????????????????????????????
        ?
???????????????????????????????????????????????????????????????????
?                    ChatTurn Response                            ?
?              (Content + Optional Widgets)                       ?
???????????????????????????????????????????????????????????????????
```

## Component Interaction Diagram

```
??????????????????????????????????????????????????????????????
?                    ChatService                             ?
?  ???????????????????????????????????????????????????????? ?
?  ? SendMessageWithTriageAsync(message, triageAgent)    ? ?
?  ? 1. Create ChatRequest with metadata                 ? ?
?  ? 2. Store user message in metadata                   ? ?
?  ? 3. Invoke triageAgent.InvokeAsync()                ? ?
?  ? 4. Extract classification from metadata             ? ?
?  ? 5. Log routing information                          ? ?
?  ? 6. Return response                                  ? ?
?  ???????????????????????????????????????????????????????? ?
??????????????????????????????????????????????????????????????
        ?                           ?
?????????????????????    ????????????????????????
?  TriageAgent      ?    ? Specialized Agent    ?
?  ??????????????? ?    ? ??????????????????  ?
?  ?Classifier  ? ?    ? ?InterAgentCtx   ?  ?
?  ?Registry    ? ?    ? ?GetClassification   ?
?  ?Routing Map ? ?    ? ?GetUserMessage  ?  ?
?  ??????????????? ?    ? ??????????????????  ?
?????????????????????    ????????????????????????
        ?
???????????????????????????????????????????????????????????????
?           InterAgentCommunicationContext                    ?
?  ????????????????????????????????????????????????????????  ?
?  ? Storage: request.Metadata (Dictionary)              ?  ?
?  ?                                                      ?  ?
?  ? Keys:                                                ?  ?
?  ? - "Classification" ? TCategory enum value           ?  ?
?  ? - "UserMessage" ? string                            ?  ?
?  ? - "RoutedAgent" ? string (agent name)              ?  ?
?  ? - "PreviousResult" ? object (previous result)      ?  ?
?  ????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????
```

## Data Flow

### Request Flow
```
User Input
    ? [in metadata]
ChatRequest (ThreadId, RequestServices, Metadata with UserMessage)
    ?
TriageAgent.InvokeAsync()
    ?? Classifier.ClassifyAsync(message) ? TCategory
    ?? Store classification in metadata
    ?? Look up agent from registry
    ?? Call agent.InvokeAsync()
        ?
    Specialized Agent accesses:
    ?? InterAgentCommunicationContext.GetUserMessage()
    ?? InterAgentCommunicationContext.GetClassification()
    ?? Generates response (ChatTurn)
    ?
Response returned to user
```

### Metadata Flow
```
Before Triage:
Metadata = {}

After Classification:
Metadata = {
  "UserMessage": "help, I'm locked out",
  "Classification": UserIntent.HelpRequest,
  "RoutedAgent": "help-agent"
}

Specialized Agent reads:
- Classification ? "I know this is a HelpRequest"
- UserMessage ? "I know the user wants help being locked out"
- RoutedAgent ? "I am the help-agent"
```

## Class Relationships

```
IClassifier<TCategory>
    ?
    ?? UserIntentClassifier (Sample)

IAgentRegistry
    ?
    ?? AgentRegistry

IAgent
    ?
    ?? TriageAgent<TCategory>
    ?? (Specialized Agents)
        ?? HelpAgent (Sample)
        ?? DataQueryAgent (Sample)
        ?? ActionAgent (Sample)
        ?? FeedbackAgent (Sample)

IAgentMiddleware
    ?
    ?? TriageMiddleware (optional)

ChatRequest
    ?? has Metadata (Dictionary<string, object>)

InterAgentCommunicationContext
    ?? Static helper for metadata access
```

## Registration Flow (DI Setup)

```
services.AddTriageAgentSystem()
    ?
    ?? Register IClassifier<UserIntent> ? UserIntentClassifier
    ?
    ?? Register IAgentRegistry ? AgentRegistry (Singleton)
    ?   ?? Register agents:
    ?       ?? "help-agent" ? new HelpAgent()
    ?       ?? "data-query-agent" ? new DataQueryAgent()
    ?       ?? "action-agent" ? new ActionAgent()
    ?       ?? "feedback-agent" ? new FeedbackAgent()
    ?
    ?? Register TriageAgent<UserIntent> (Scoped)
        ?? Constructor receives:
            ?? IClassifier<UserIntent> (from DI)
            ?? IAgentRegistry (from DI)
            ?? Routing mapping function
```

## Execution Timeline

```
Time  Event                           State
????????????????????????????????????????????????????????????
T0    User sends message              "help, I'm locked out"
      
T1    ChatService.SendMessageWithTriageAsync()
      Create ChatRequest
      Store message in metadata       Metadata["UserMessage"] = "help, I'm locked out"
      
T2    TriageAgent.InvokeAsync()
      Get user message from metadata
      Call classifier                 Classifier.ClassifyAsync("help, I'm locked out")
      
T3    Classifier analyzes             HelpRequest ? Classification result
      
T4    Store classification            Metadata["Classification"] = HelpRequest
      Look up agent                   registry.GetAgent("help-agent")
      Store agent name                Metadata["RoutedAgent"] = "help-agent"
      
T5    HelpAgent.InvokeAsync()
      Get classification              InterAgentCommunicationContext.GetClassification()
      Get user message                InterAgentCommunicationContext.GetUserMessage()
      
T6    HelpAgent processes
      Generates response
      Returns ChatTurn
      
T7    Response returned to user       "I'm here to help! You asked:..."
      
T8    Response logged/stored
      Loop continues
```

## Error Handling

```
TriageAgent.InvokeAsync()
    ?? Try
    ?   ?? Extract user message
    ?   ?   ?? if null ? return Outcome<ChatTurn>.Failed("NoMessage", "...")
    ?   ?
    ?   ?? Classify via IClassifier
    ?   ?   ?? catch Exception ? return Outcome<ChatTurn>.Failed(...)
    ?   ?
    ?   ?? Look up agent
    ?   ?   ?? if null ? return Outcome<ChatTurn>.Failed("NoAgent", "...")
    ?   ?
    ?   ?? Invoke agent
    ?   ?   ?? await agent.InvokeAsync(request, ct)
    ?   ?       ?
    ?   ?       ?? Success ? return Outcome<ChatTurn>.From(result)
    ?   ?       ?? Failure ? return Outcome<ChatTurn>.Failed(...)
    ?   ?
    ?   ?? Return outcome
    ?
    ?? Catch OperationCanceledException
        ?? Re-throw (cancellation is intentional)
    ?? Catch Exception
        ?? return Outcome<ChatTurn>.Failed("TriageFailed", "...")
```

## Extension Points

```
???????????????????????????????????????????????
?  User's Custom Implementation               ?
???????????????????????????????????????????????
?                                             ?
?  1. Custom IClassifier<TCategory>          ?
?     ?? Implement ClassifyAsync()           ?
?                                             ?
?  2. Custom IAgent                          ?
?     ?? Implement InvokeAsync()             ?
?                                             ?
?  3. Custom Enum (TCategory)                ?
?     ?? Define categories                   ?
?                                             ?
?  4. Register in TriageAgentSetup           ?
?     ?? AddTriageAgentSystem() extension    ?
?                                             ?
???????????????????????????????????????????????
```

## Metadata Contract

```csharp
public Dictionary<string, object> Metadata
{
    // Set by TriageAgent
    ["UserMessage"] = string,           // "help, I'm locked out"
    ["Classification"] = TCategory,     // UserIntent.HelpRequest
    ["RoutedAgent"] = string,           // "help-agent"
    
    // Set by specialized agents
    ["PreviousResult"] = object,        // Any result from previous agent
    
    // Available for any custom use
    [custom-key] = object               // Application-specific data
}
```

## Integration Points

### With ChatWidgetService
- Triage agent produces ChatTurn
- ChatTurn has optional widgets
- Widgets are rendered on frontend
- Actions trigger handlers

### With Action Handlers
- Triage classifies initial request
- Specialized agent handles action payload
- Same agent may be called for multiple actions
- Metadata available to handlers

### With DI Container
- Services.AddTriageAgentSystem()
- Automatic registration of all components
- Scoped/Singleton lifecycle management
- Easy to override implementations

## Performance Considerations

1. **Classification Time**: ~100-500ms (AI-based)
2. **Registry Lookup**: O(1) dictionary access
3. **Metadata Access**: O(1) dictionary access
4. **Agent Invocation**: Depends on agent implementation
5. **Total Request Time**: Classification + Agent processing

**Optimization**: Cache classifier results for similar messages

---

## Quick Reference

### Create Request
```csharp
var request = new ChatRequest(threadId, serviceProvider)
{
    Metadata = new Dictionary<string, object> 
    { 
        { "UserMessage", message } 
    }
};
```

### Get Classification
```csharp
var classification = InterAgentCommunicationContext
    .GetClassification<UserIntent>(request);
```

### Register Agent
```csharp
registry.Register("agent-name", new MyAgent());
```

### Invoke Triage Agent
```csharp
var outcome = await triageAgent.InvokeAsync(request, cancellationToken);
```

---

**This architecture enables flexible, type-safe, AI-powered request routing with full inter-agent communication.**
