@using Microsoft.AspNetCore.Components
@implements IDisposable

@code {
    private readonly Guid instanceId = Guid.NewGuid();

    [CascadingParameter]
    private WidgetOverrideCollector? Collector { get; set; }

    [Parameter]
    public Type? Type { get; set; }

    [Parameter]
    public string? TypeId { get; set; }

    [Parameter]
    public Type? Template { get; set; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        if (Collector is null)
        {
            throw new InvalidOperationException($"{nameof(WidgetOverride)} must be used inside {nameof(WidgetRenderer)}.{nameof(WidgetRenderer.Overrides)}.");
        }

        if (Template is null)
        {
            throw new InvalidOperationException($"{nameof(Template)} must be provided.");
        }

        Collector.Upsert(instanceId, new WidgetComponentOverride(Type, TypeId, Template));
    }

    public void Dispose()
    {
        Collector?.Remove(instanceId);
    }
}
