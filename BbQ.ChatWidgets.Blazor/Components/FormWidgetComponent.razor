@using BbQ.ChatWidgets.Models
@using Microsoft.AspNetCore.Components

<div class="bbq-widget bbq-form-widget">
    <div class="bbq-form">
        @if (!string.IsNullOrEmpty(Widget?.Title))
        {
            <h3 class="bbq-form-title">@Widget.Title</h3>
        }
        
        <div class="bbq-form-fields">
            @if (Widget?.Fields != null)
            {
                @foreach (var field in Widget.Fields)
                {
                    <FormFieldComponent 
                        Field="field" 
                        OnValueChanged="HandleFieldValueChanged" 
                        OnValidationChanged="HandleFieldValidationChanged" />
                }
            }
        </div>

        <div class="bbq-form-actions">
            @if (Widget?.Actions != null)
            {
                @foreach (var action in Widget.Actions)
                {
                    var isSubmit = action.Type.Equals("submit", StringComparison.OrdinalIgnoreCase);
                    var isDisabled = isSubmit && !IsFormValid();
                    <button 
                        class="bbq-button bbq-form-action-@action.Type @(isDisabled ? "bbq-button-disabled" : "")" 
                        @onclick="@(async () => await HandleActionClick(action.Type))"
                        disabled="@isDisabled">
                        @action.Label
                    </button>
                }
            }
        </div>

        @if (!IsFormValid() && hasAttemptedSubmit)
        {
            <div class="bbq-form-validation-message">
                <p>Please fill in all required fields before submitting.</p>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public FormWidget? Widget { get; set; }

    [Parameter]
    public EventCallback<(string Action, object? Payload)> OnAction { get; set; }

    private Dictionary<string, object?> formData = new();
    private Dictionary<string, bool> fieldValidationState = new();
    private bool hasAttemptedSubmit = false;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        
        // Initialize validation state for all fields
        if (Widget?.Fields != null)
        {
            foreach (var field in Widget.Fields)
            {
                // Non-required fields are valid by default
                fieldValidationState[field.Name] = !field.Required;
            }
        }
    }

    private void HandleFieldValueChanged((string fieldName, object? value) args)
    {
        formData[args.fieldName] = args.value;
    }

    private void HandleFieldValidationChanged((string fieldName, bool isValid) args)
    {
        fieldValidationState[args.fieldName] = args.isValid;
        StateHasChanged();
    }

    private bool IsFormValid()
    {
        if (Widget?.Fields == null || fieldValidationState.Count == 0)
            return true;

        // Check if all required fields are valid
        foreach (var field in Widget.Fields)
        {
            if (field.Required)
            {
                if (!fieldValidationState.TryGetValue(field.Name, out var isValid) || !isValid)
                {
                    return false;
                }
            }
        }

        return true;
    }

    private async Task HandleActionClick(string actionType)
    {
        var actionName = actionType switch
        {
            "submit" => Widget?.Action ?? "form_submit",
            "cancel" => "form_cancel",
            _ => "form_action"
        };

        // If submit action, check validation
        if (actionType.Equals("submit", StringComparison.OrdinalIgnoreCase))
        {
            hasAttemptedSubmit = true;
            
            if (!IsFormValid())
            {
                StateHasChanged();
                return; // Don't submit if form is invalid
            }
        }
        
        var payload = new { formData = formData };
        await OnAction.InvokeAsync((actionName, payload));
    }
}
