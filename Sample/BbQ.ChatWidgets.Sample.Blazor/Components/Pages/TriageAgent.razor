@rendermode @(new InteractiveServerRenderMode())
@page "/triage-agent"
@using BbQ.ChatWidgets.Models
@using BbQ.ChatWidgets.Sample.Blazor.Components.Models
@using BbQ.ChatWidgets.Sample.Shared.Agents
@using Microsoft.Extensions.AI
@using Microsoft.AspNetCore.Components.Web
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager

<PageTitle>Triage Agent - BbQ Chat Widgets</PageTitle>

<div class="triage-page">
    <div class="chat-container">
        <div class="chat-header">
            <button class="btn-back" @onclick="GoBack">← Back</button>
            <div class="header-content">
                <h1>🎯 Triage Agent</h1>
                <p>Automatic message classification and agent routing</p>
            </div>
            <div class="thread-info">
                <small>Thread ID: @threadId</small>
            </div>
        </div>

        <CustomChatContainer ChatTurns="chatTurns" IsLoading="isLoading" OnAction="@(EventCallback.Factory.Create<(string Action, object? Payload)>(this, HandleWidgetAction))" />

        @if (classificationInfo != null)
        {
            <div class="classification-banner">
                <div class="classification-badge">
                    <span class="badge-label">Intent:</span>
                    <span class="badge-value">@classificationInfo.Intent</span>
                </div>
                <div class="classification-badge">
                    <span class="badge-label">Routed Agent:</span>
                    <span class="badge-value">@classificationInfo.RoutedAgent</span>
                </div>
            </div>
        }

        <div class="chat-input-section">
            <div class="input-group">
                <textarea 
                    @bind="userInput"
                    @bind:event="oninput"
                    placeholder="Type a message to be classified and routed..."
                    @onkeyup="HandleKeyUp"
                    disabled="@isLoading"
                    rows="3"></textarea>
                <button 
                    class="btn btn-send" 
                    @onclick="@(async () => await SendMessage())"
                    disabled="@(isLoading || string.IsNullOrWhiteSpace(userInput))">
                    @if (isLoading) { <span>Classifying...</span> } else { <span>Send</span> }
                </button>
            </div>
            @if (!string.IsNullOrEmpty(error))
            {
                <div class="error-message">@error</div>
            }
        </div>
    </div>

    <aside class="scenario-sidebar">
        <h3>📖 About This Scenario</h3>
        <p>
            <strong>Triage Agent</strong> automatically classifies your message and routes it to the appropriate specialized agent.
        </p>

        <div class="info-section">
            <h4>Intent Categories</h4>
            <ul class="intent-list">
                @foreach (var item in sampleIntents)
                {
                    <li>
                        <strong>@item.Intent:</strong> @item.Text
                    </li>
                }
            </ul>
        </div>

        <div class="info-section">
            <h4>Agent Routing</h4>
            <ul class="routing-list">
                <li><strong>HelpRequest</strong> → help-agent (Support)</li>
                <li><strong>DataQuery</strong> → data-query-agent (Information)</li>
                <li><strong>ActionRequest</strong> → action-agent (Operations)</li>
                <li><strong>Feedback</strong> → feedback-agent (Feedback)</li>
                <li><strong>Unknown</strong> → help-agent (Fallback)</li>
            </ul>
        </div>

        <div class="info-section">
            <h4>🚀 Quick Test</h4>
            <p>Try one of these sample messages:</p>
            <div class="sample-buttons">
                @foreach (var item in sampleIntents)
                {
                    <button 
                        class="sample-button" 
                        @onclick="@(async () => await SendMessage(item.Text))"
                        disabled="@isLoading">
                        @item.Intent
                    </button>
                }
            </div>
        </div>
    </aside>
</div>

<style>
    .triage-page {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 0;
        height: 100vh;
        background-color: var(--color-bg-primary);
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: var(--color-bg-primary);
    }

    .chat-header {
        padding: 1rem;
        background: var(--color-header-gradient);
        color: white;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-back {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .btn-back:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .header-content {
        flex: 1;
    }

    .header-content h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .header-content p {
        margin: 0.25rem 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
    }

    .thread-info {
        opacity: 0.8;
        font-size: 0.85rem;
    }

    .classification-banner {
        padding: 0.75rem 1.5rem;
        background-color: var(--color-bg-secondary);
        border-bottom: 1px solid var(--color-border-light);
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .classification-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .badge-label {
        font-weight: 600;
        color: var(--color-text-secondary);
        font-size: 0.9rem;
    }

    .badge-value {
        padding: 0.25rem 0.75rem;
        background-color: var(--color-accent);
        color: white;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .chat-input-section {
        padding: 1.5rem;
        background-color: var(--color-bg-secondary);
        border-top: 1px solid var(--color-border-light);
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .input-group {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }

    .input-group textarea {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid var(--color-input-border);
        border-radius: 4px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 1rem;
        resize: none;
        min-height: 60px;
        background-color: var(--color-input-bg);
        color: var(--color-text-primary);
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .input-group textarea:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px var(--color-focus-ring);
    }

    .btn-send {
        padding: 0.75rem 1.5rem;
        background-color: var(--color-accent);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .btn-send:hover:not(:disabled) {
        background-color: var(--color-accent-hover);
        transform: translateY(-1px);
    }

    .btn-send:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .error-message {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background-color: #fee;
        color: #c33;
        border-radius: 4px;
        border-left: 3px solid #c33;
    }

    .scenario-sidebar {
        background: var(--color-bg-secondary);
        border-left: 1px solid var(--color-border-light);
        padding: 1.5rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        transition: background-color 0.3s ease;
    }

    .scenario-sidebar h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
        color: var(--color-text-primary);
    }

    .scenario-sidebar > p {
        margin: 0 0 1rem 0;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
    }

    .info-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .info-section h4 {
        margin: 0;
        font-size: 0.95rem;
        color: var(--color-text-primary);
        font-weight: 600;
    }

    .intent-list,
    .routing-list {
        margin: 0;
        padding-left: 1.25rem;
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        line-height: 1.6;
    }

    .intent-list li,
    .routing-list li {
        margin-bottom: 0.5rem;
    }

    .sample-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .sample-button {
        padding: 0.5rem 0.75rem;
        background-color: var(--color-card-bg);
        color: var(--color-text-primary);
        border: 1px solid var(--color-border-light);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        text-align: left;
    }

    .sample-button:hover:not(:disabled) {
        background-color: var(--color-card-hover-bg);
        border-color: var(--color-accent);
        transform: translateX(2px);
    }

    .sample-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    @@media (max-width: 1200px) {
        .triage-page {
            grid-template-columns: 1fr;
        }

        .scenario-sidebar {
            border-left: none;
            border-top: 1px solid var(--color-border-light);
            max-height: 250px;
            padding: 1rem;
        }
    }
</style>

@code {
    private string userInput = "";
    private string error = "";
    private bool isLoading = false;
    private List<ChatTurn> chatTurns = new();
    private string threadId = Guid.NewGuid().ToString();
    private ClassificationInfo? classificationInfo;

    private List<SampleIntent> sampleIntents = new()
    {
        new SampleIntent { Text = "I need help resetting my password", Intent = "HelpRequest" },
        new SampleIntent { Text = "Show me the sales data for Q4", Intent = "DataQuery" },
        new SampleIntent { Text = "Delete my account", Intent = "ActionRequest" },
        new SampleIntent { Text = "Your service is amazing!", Intent = "Feedback" }
    };

    protected override async Task OnInitializedAsync()
    {
        chatTurns.Add(new ChatTurn(
            ChatRole.Assistant,
            "Welcome to the Triage Agent! Send a message and it will be automatically classified and routed to the appropriate specialized agent. Try asking for help, requesting data, or providing feedback."
        ));
    }

    private async Task SendMessage(string? messageText = null)
    {
        var textToSend = messageText ?? userInput;
        if (string.IsNullOrWhiteSpace(textToSend))
            return;

        try
        {
            error = "";
            isLoading = true;
            classificationInfo = null;
            StateHasChanged();

            chatTurns.Add(new ChatTurn(ChatRole.User, textToSend));
            if (messageText == null)
            {
                userInput = "";
            }
            StateHasChanged();
            var baseUri = NavigationManager.BaseUri.TrimEnd('/');
            var response = await HttpClient.PostAsJsonAsync(
                $"{baseUri}/api/chat/agent",
                new UserMessageRequest(Message: textToSend, ThreadId: threadId));

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SampleChatTurn>(BbQ.ChatWidgets.Models.Serialization.Default);

                chatTurns.Add(new ChatTurn(
                    ChatRole.Assistant,
                    result?.Content ?? "I didn't understand that. Could you rephrase?",
                    result?.Widgets));

                threadId = result?.ThreadId ?? threadId;

                // Show simple classification success indicator
                classificationInfo = new ClassificationInfo
                {
                    Intent = result?.Metadata["classification"]?.ToString() ?? "Unclassified",
                    RoutedAgent = result?.Metadata["routedAgent"]?.ToString() ?? "Unknown Agent"
                };
            }
            else
            {
                error = $"Error: {response.StatusCode} - {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            error = $"Error sending message: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleWidgetAction((string Action, object? Payload) args)
    {
        var (action, payload) = args;

        if (string.IsNullOrWhiteSpace(threadId))
        {
            error = "No active thread.";
            return;
        }

        try
        {
            error = "";
            isLoading = true;
            classificationInfo = null;

            chatTurns.Add(new ChatTurn(
                ChatRole.User,
                $"**Action triggered:** `{action}`"));
            StateHasChanged();
            var baseUri = NavigationManager.BaseUri.TrimEnd('/');
            var response = await HttpClient.PostAsJsonAsync(
                $"{baseUri}/api/chat/action",
                new ChatActionRequest(Action: action, Payload: payload, ThreadId: threadId));

            if (response.IsSuccessStatusCode)
            {
                var turn = await response.Content.ReadFromJsonAsync<ChatTurn>(BbQ.ChatWidgets.Models.Serialization.Default);

                chatTurns.Add(new ChatTurn(
                    ChatRole.Assistant,
                    turn?.Content ?? "",
                    turn?.Widgets));

                threadId = turn?.ThreadId ?? threadId;
            }
            else
            {
                error = $"Error: {response.StatusCode} - {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            error = $"Error sending action: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "Enter" && !args.ShiftKey)
        {
            await SendMessage();
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/");
    }

    private class ClassificationInfo
    {
        public string Intent { get; set; } = "Unknown";
        public string RoutedAgent { get; set; } = "Default";
    }

    private class SampleIntent
    {
        public string Text { get; set; } = "";
        public string Intent { get; set; } = "";
    }
}
